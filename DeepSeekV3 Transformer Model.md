```
                                    ┌─────────────────────────────────────────────────────────────────┐
                                    │                        DeepSeek-V3 Transformer                  │
                                    └─────────────────────────────────────────────────────────────────┘
                                                                  输入
                                                                    ↓
                                    ┌─────────────────────────────────────────────────────────────────┐
                                    │                    Parallel Embedding Layer                     │
                                    └─────────────────────────────────────────────────────────────────┘
                                                                    ↓
                                    ┌─────────────────────────────────────────────────────────────────┐
                                    │          Rotary Position Encoding( (RoPE with YaRN) )           │
                                    └─────────────────────────────────────────────────────────────────┘
                                                                    ↓
                                    ┌─────────────────────────────────────────────────────────────────┐
                                    │                    Transformer Blocks (× n_layers)              │
                                    ├─────────────────────────────────────────────────────────────────┤
                                    │  ┌────────────────────────────────────────────────────────────┐ │
                                    │  │                    Transformer Block                       │ │
                                    │  │  ┌─────────────────────────────────────────────────────┐   │ │
                                    │  │  │              Residual Connection 1                  │   │ │
                                    │  │  └─────────────────────────────────────────────────────┘   │ │
                                    │  │                            ↓                               │ │
                                    │  │  ┌─────────────────────────────────────────────────────┐   │ │
                                    │  │  │                  RMSNorm (Attention)                │   │ │
                                    │  │  └─────────────────────────────────────────────────────┘   │ │
                                    │  │                            ↓                               │ │
                                    │  │  ┌─────────────────────────────────────────────────────┐   │ │
                                    │  │  │          Multi-Head Latent Attention (MLA)          │   │ │
                                    │  │  │  ┌──────────────────────────────────────────────────┐   │ │
                                    │  │  │  │                      Query Projection            │   │ │
                                    │  │  │  │      ┌─────────┐  ┌─────────┐  ┌─────────┐       │   │ │
                                    │  │  │  │      │ LoRA A  │→ │ RMSNorm │→ │ LoRA B  │       │   │ │
                                    │  │  │  │      └─────────┘  └─────────┘  └─────────┘       │   │ │
                                    │  │  │  └──────────────────────────────────────────────────┘   │ │
                                    │  │  │  ┌──────────────────────────────────────────────────┐   │ │
                                    │  │  │  │                    Key-Value Projection          │   │ │
                                    │  │  │  │        wkv_a → [kv, k_pe] → RMSNorm → wkv_b      │   │ │
                                    │  │  │  │                    ↓         ↓                   │   │ │
                                    │  │  │  │            [k_nope, v]    k_pe(rotary)           │   │ │
                                    │  │  │  └──────────────────────────────────────────────────┘   │ │
                                    │  │  │  ┌──────────────────────────────────────────────────┐   │ │
                                    │  │  │  │                  Attention Computation            │  │ │
                                    │  │  │  │    scores = (q_nope·k_nope + q_pe·k_pe) / √d      │  │ │
                                    │  │  │  │    attn_weights = softmax(scores + mask)          │  │ │
                                    │  │  │  │    output = attn_weights · v                      │  │ │
                                    │  │  │  └───────────────────────────────────────────────────┘  │ │
                                    │  │  │  ┌───────────────────────────────────────────────────┐  │ │
                                    │  │  │  │                    Output Projection              │  │ │
                                    │  │  │  └───────────────────────────────────────────────────┘  │ │
                                    │  │  └──────────────────────────────────────────────────────┘  │ │
                                    │  │                            ↓                               │ │
                                    │  │  ┌─────────────────────────────────────────────────────┐   │ │
                                    │  │  │              Residual Connection 2                  │   │ │
                                    │  │  └─────────────────────────────────────────────────────┘   │ │
                                    │  │                            ↓                               │ │
                                    │  │  ┌─────────────────────────────────────────────────────┐   │ │
                                    │  │  │                  RMSNorm (FFN)                      │   │ │
                                    │  │  └─────────────────────────────────────────────────────┘   │ │
                                    │  │                            ↓                               │ │
                                    │  │  ┌─────────────────────────────────────────────────────┐   │ │
                                    │  │  │        FeedForward Network (Dense or MoE)           │   │ │
                                    │  │  │      ┌───────────────────┐  ┌─────────────────┐     │   │ │
                                    │  │  │      │   Dense Layers    │  │   MoE Layers    │     │   │ │
                                    │  │  │      │  (n_dense_layers) │  │  (剩余layers)   │     │   │ │
                                    │  │  │      │                   │  │                 │     │   │ │
                                    │  │  │      │  MLP:             │  │  MoE:           │     │   │ │
                                    │  │  │      │  - w1(SiLU)       │  │  - Gate路由     │     │   │ │
                                    │  │  │      │  - w3(linear)     │  │  - Expert计算   │     │   │ │
                                    │  │  │      │  - w2(project)    │  │  - Shared专家   │     │   │ │
                                    │  │  │      │                   │  │                 │     │   │ │
                                    │  │  │      └───────────────────┘  └─────────────────┘     │   │ │
                                    │  │  └─────────────────────────────────────────────────────┘   │ │
                                    │  │                            ↓                               │ │
                                    │  │  ┌─────────────────────────────────────────────────────┐   │ │
                                    │  │  │                      output                         │   │ │
                                    │  │  └─────────────────────────────────────────────────────┘   │ │
                                    │  └────────────────────────────────────────────────────────────┘ │
                                    │                            × n_layers                           │
                                    └─────────────────────────────────────────────────────────────────┘
                                                                    ↓
                                    ┌─────────────────────────────────────────────────────────────────┐
                                    │                      Final RMSNorm                              │
                                    └─────────────────────────────────────────────────────────────────┘
                                                                    ↓
                                    ┌─────────────────────────────────────────────────────────────────┐
                                    │                    Output Projection                            │
                                    └─────────────────────────────────────────────────────────────────┘
                                                                    ↓
                                                                  输出
```
